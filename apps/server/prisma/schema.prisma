generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

model User {
  id                   String                @id @default(uuid())
  email                String                @unique
  name                 String?
  avatarUrl            String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  executions           Execution[]
  toolConnections      ToolConnection[]
  memories             Memory[]
  conversationMessages ConversationMessage[]
  agents               Agent[]
}

model ToolConnection {
  id                   String    @id @default(uuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id])
  toolName             String
  provider             String
  composioConnectionId String?
  status               String    @default("active")
  permissions          Json?
  connectedAt          DateTime  @default(now())
  revokedAt            DateTime?

  @@unique([userId, toolName])
  @@index([userId])
}

model Execution {
  id            String         @id @default(uuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  agentId       String?
  agent         Agent?         @relation(fields: [agentId], references: [id])
  prompt        String
  status        String         @default("pending")
  riskLevel     String?
  plan          Json?
  results       Json?
  error         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  completedAt   DateTime?
  toolCalls     ToolCall[]
  auditLogs     AuditLog[]
  artifacts     Artifact[]
  sharedReports SharedReport[]

  @@index([userId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
}

model ToolCall {
  id          String    @id @default(uuid())
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stepId      String
  toolName    String
  parameters  Json
  status      String    @default("pending")
  result      Json?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([executionId])
  @@index([stepId])
}

model AuditLog {
  id          String     @id @default(uuid())
  executionId String?
  execution   Execution? @relation(fields: [executionId], references: [id], onDelete: SetNull)
  action      String
  actor       String
  details     Json?
  createdAt   DateTime   @default(now())

  @@index([executionId])
  @@index([action])
  @@index([createdAt])
}

model Memory {
  id        String                       @id @default(uuid())
  userId    String
  user      User                         @relation(fields: [userId], references: [id])
  type      String // 'execution' | 'tool_result' | 'conversation' | 'pattern'
  content   String
  embedding Unsupported("vector(768)")?
  metadata  Json?
  createdAt DateTime                     @default(now())

  @@index([userId])
  @@index([type])
}

model ConversationMessage {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  role        String // 'user' | 'assistant' | 'system'
  content     String
  executionId String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
}

model Artifact {
  id          String    @id @default(uuid())
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  type        String // 'log_bundle' | 'report' | 'file' | 'data'
  name        String
  mimeType    String
  size        Int
  storagePath String
  publicUrl   String?
  metadata    Json?
  createdAt   DateTime  @default(now())

  @@index([executionId])
}

model SharedReport {
  id          String    @id @default(uuid())
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  token       String    @unique
  expiresAt   DateTime?
  viewCount   Int       @default(0)
  createdAt   DateTime  @default(now())

  @@index([token])
}

model Agent {
  id           String      @id @default(uuid())
  userId       String? // null for built-in agents
  user         User?       @relation(fields: [userId], references: [id])
  name         String
  description  String
  icon         String?
  systemPrompt String
  toolNames    String[] // Postgres array of allowed tool names
  memoryScope  String      @default("shared") // 'shared' | 'isolated' | 'none'
  isBuiltin    Boolean     @default(false)
  isPublic     Boolean     @default(false)
  config       Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  executions   Execution[]

  @@index([userId])
  @@index([isBuiltin])
  @@index([isPublic])
}
